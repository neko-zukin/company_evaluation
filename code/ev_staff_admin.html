<html>
<head>
	<meta charset="UTF-8">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="DB_sql.js"></script>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<h1>ç¤¾å“¡ç®¡ç†</h1>
	<div class="staff_admin">
		<table border="1" id="staff_tb">
			<tr>
				<th class="staff_th_id pk_th0">ç¤¾å“¡ç•ªå·</th>
				<th class="staff_th_name pk_th1">æ°å</th>
				<th class="staff_th_date">ç”Ÿå¹´æœˆæ—¥</th>
				<th class="staff_th_date">å…¥ç¤¾æ—¥</th>
				<th class="staff_th_pt">pt</th>
				<th class="staff_th_pt">Expt</th>
				<th class="staff_th_ac">å­¦æ­´</th>
				<th class="staff_th_y">å‹¤ç¶šå¹´æ•°</th>
				<th class="staff_th_y">ITçµŒæ­´</th>
				<th class="staff_th_y">ITä»¥å¤–<br>çµŒæ­´</th>
			</tr>
			<!--ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥-->
		</table>

		<div class="staff_input">
			<div>
				<label>ç¤¾å“¡ç•ªå·</label>
				<input type="text" id="staff_id_inp">
				<label>æ°å</label>
				<input type="text" id="staff_name_inp">
			</div>
			<div>
				<label>ç”Ÿå¹´æœˆæ—¥</label>
				<input type="date" id="birthday_inp">
				<label>å…¥ç¤¾æ—¥</label>
				<input type="date" id="join_date_inp">
			</div>
			<div>
				<label>å­¦æ­´</label>
				<select id="ac_history_inp">
					<option value="null" style="text-align: center;">â€•</option>
					<option value="é«˜å’">é«˜å’</option>
					<option value="å°‚é–€å’">å°‚é–€å’</option>
					<option value="å¤§å’(æ–‡ç³»)">å¤§å’(æ–‡ç³»)</option>
					<option value="å¤§å’(ç†ç³»)">å¤§å’(ç†ç³»)</option>
				</select>
				<label>å‹¤ç¶šå¹´æ•°(å¹´)</label>
				<input type="number" id="society_history_inp">
			</div>
			<div>
				<label>ITçµŒé¨“(å¹´)</label>
				<input type="number" id="it_history_inp">
				<label>ITä»¥å¤–çµŒé¨“(å¹´)</label>
				<input type="number" id="noit_history_inp">
			</div>
			<div>
				<label>pt</label>
				<input type="number" id="pt_inp" disabled>
				<label>Expt</label>
				<input type="number" id="Expt_inp" disabled>
			</div>
			<div class="del_flg">
				<label>å‰Šé™¤ãƒ•ãƒ©ã‚°</label>
				<input type="checkbox" id="del_flg_inp">
			</div>
			
			<!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
			<div class="admin_error">
				<p id="error_1" hidden>â€»ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
				<p id="error_2" hidden>â€»æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
				<p id="error_3" hidden>â€»ãã®ç¤¾å“¡ç•ªå·ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚</p>
				<p id="error_4" hidden>â€»ç¤¾å“¡ç•ªå·ã¯6æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
				<p id="error_5" hidden>â€»æ°åã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
				<p id="error_6" hidden>â€»ptã®ä¸Šé™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚</p>
				<p id="error_7" hidden>â€»Exptã®ä¸Šé™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚</p>
				<p id="error_8" hidden>â€»å‹¤ç¶šå¹´æ•°ã®ä¸Šé™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚</p>
				<p id="error_9" hidden>â€»ITçµŒé¨“(å¹´)ã®ä¸Šé™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚</p>
				<p id="error_10" hidden>â€»ITä»¥å¤–çµŒé¨“(å¹´)ã®ä¸Šé™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚</p>
			</div>
		</div>	
	</div>

	<div class="admin_btn">
		<button id="back_button">æˆ»ã‚‹</button>
		<button id="insert_button">ç™»éŒ²</button>
		<button id="update_button">æ›´æ–°</button>
	</div>
	<!--ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ™‚ã®ã‚°ãƒ¬ãƒ¼å‡¦ç†-->
	<div id="pop_back"></div>
	<!--æ›´æ–°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—-->
	<div class="pop" id="UPDATE">
		<button class="pop_cancel" >âœ–</button>
		<div class="pop_title_alone">æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ</div>
		<button class="pop_button_alone" id="update_ok">OK</button>
	</div>
	<!--ç™»éŒ²ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—-->
	<div class="pop" id="INSERT">
		<button class="pop_cancel" >âœ–</button>
		<div class="pop_title_alone">ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</div>
		<button class="pop_button_alone" id="insert_ok">OK</button>
	</div>
	<!--æˆ»ã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—-->
	<div class="pop" id="BACK">
		<button class="pop_cancel">âœ–</button>
		<div class="pop_title"><span>â€»ä¿å­˜ã‚’ã—ã¦ã„ãªã„ãŸã‚<br>å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ã€‚</span><br>ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
		<button class="pop_button_alone" id="back_ok">OK</button>
	</div>
</body>
<script>
	//ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
	window.addEventListener('load', function() {
		window.addEventListener('popstate', function(event) {
			alert('ã‚‚ã†ä¸€åº¦ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä¿å­˜ã—ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ğŸ˜±');
		});
		history.pushState(null, null, null);
	});

	// DBã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç¤¾å“¡ã‚’è¡¨ç¤º
	let staff = DB.sql("SELECT * FROM TM_staff;");

	// å‹¤ç¶šå¹´æ•°ã®è¨ˆç®—
	let date = new Date();
	let date_yyyymm = date.toISOString()
	let ev_date = date_yyyymm.slice(0,7);
	let year = ev_date.slice(0,4);
	let month = ev_date.slice(5,7);
	let birthday = staff[9]["birthday"].slice(0,4);
	let job_history = staff[9]["join_date"].slice(0,4);
	let staff_old = parseInt(year)-parseInt(birthday);
	let staff_society_history = parseInt(year)-parseInt(job_history);

	console.log(staff);
	for(let i=0; i<staff.length; i++){
		$("#staff_tb").append('<tr id="tr'+i+'"></tr>');
		$("#tr"+i).append('<td id="staff_id_'+i+'" class="pk_td0">'+staff[i]["staff_id"]+'</td>');
		$("#tr"+i).append('<td id="staff_name_'+i+'" class="pk_td1">'+staff[i]["staff_name"]+'</td>');
		tb_null(i, "birthday", staff[i]["birthday"]);
		tb_null(i, "join_date", staff[i]["join_date"]);
		tb_null(i, "pt", staff[i]["pt"]);
		tb_null(i, "Expt", staff[i]["Expt"]);
		tb_null(i, "ac_history", staff[i]["ac_history"]);
		tb_null(i, "society_history", staff[i]["society_history"]);
		tb_null(i, "it_history", staff[i]["it_history"]);
		tb_null(i, "noit_history", staff[i]["noit_history"]);
	}
	
	// nullã®å ´åˆã€-(ãƒã‚¤ãƒ•ãƒ³)ã‚’è¿”ã™(tableç”¨)
	function tb_null(i, col, data){
		if(data==null){
			// nullã®å ´åˆ
			$("#tr"+i).append('<td id="'+col+i+'" class="tb_null">-</td>');
		}else{
			// nullã§ãªã„å ´åˆ
			$("#tr"+i).append('<td id="'+col+i+'">'+data+'</td>');
		}
	}

	// ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸåˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ä»£å…¥ã™ã‚‹
	for(let i=0; i<staff.length; i++){
		$("#tr"+i).on("click",function(){
			console.log();
			$("#staff_id_inp").val(staff[i]["staff_id"]);
			$("#staff_name_inp").val(staff[i]["staff_name"]);
			inp_null(i, "birthday", staff[i]["birthday"]);
			inp_null(i, "join_date", staff[i]["join_date"]);
			inp_null(i, "pt", staff[i]["pt"]);
			inp_null(i, "Expt", staff[i]["Expt"]);
			// inp_null(i, "ac_history", staff[i]["ac_history"]);
			if(staff[i]["ac_history"]==null){
				// nullã®å ´åˆ
				$("#ac_history_inp").val("null");
			}else{
				// nullã§ãªã„å ´åˆ
				$("#ac_history_inp").val(staff[i]["ac_history"]);
			}
			inp_null(i, "society_history", staff[i]["society_history"]);
			inp_null(i, "it_history", staff[i]["it_history"]);
			inp_null(i, "noit_history", staff[i]["noit_history"]);
			if(staff[i]["del_flg"]){
				// å‰Šé™¤ãƒ•ãƒ©ã‚°ãŒtrueã®å ´åˆ
				$("#del_flg_inp").prop('checked', true);
			}else{
				// å‰Šé™¤ãƒ•ãƒ©ã‚°ãŒfalseã®å ´åˆ
				$("#del_flg_inp").prop('checked', false);
			}
		});
	}

	// inputç”¨nullãƒã‚§ãƒƒã‚¯
	function inp_null(i, col, data){
		if(data!=null){
			// nullã®å ´åˆ
			$("#"+col+"_inp").val(data);
		}else{
			// nullã§ãªã„å ´åˆ
			$("#"+col+"_inp").val("");
		}
	}

	// ç¾åœ¨æ—¥æ™‚
	let now = year+'-'+month+'-'+("00" + (date.getDate())).slice(-2);
	// console.log("now:"+now);

	// ç™»éŒ²ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®OKãƒœã‚¿ãƒ³ãŒæŠ¼ä¸‹ã•ã‚ŒãŸã¨ã
	$("#insert_ok").on("click",function(){
		// ç¤¾å“¡ç•ªå·ã®è‡ªå‹•å‰²ã‚Šå½“ã¦
		// let yy = year.slice(2);
		// let db_id = DB.sql('SELECT MAX(staff_id) as staff_id FROM tm_staff WHERE staff_id LIKE "'+yy+'%";');
		// // let db_id2 = DB.sql('SELECT MAX(staff_id) as staff_id FROM tm_staff WHERE staff_id LIKE "24%";');
		// console.log(db_id);
		// let max_id = Number(db_id[0]["staff_id"].slice(2))+1;
		// let new_id = yy.toString()+("000"+max_id).slice(-3);
		// console.log(new_id);

		if(error("insert")){
			// ç¤¾å“¡æƒ…å ±ç™»éŒ²ç”¨ã®SQLæ–‡
			let sql = "INSERT INTO TM_staff(staff_id, staff_name, birthday, join_date, pt, Expt, ac_history, society_history, it_history, noit_history, del_flg, create_date, create_id) ";
			sql += 'VALUES("'+$("#staff_id_inp").val()+'", ';
			sql += '"'+$("#staff_name_inp").val()+'", ';
			sql += sql_null("birthday_inp", "d")+', ';
			sql += sql_null("join_date_inp", "d")+', ';
			sql += sql_null("pt_inp", "i")+', ';
			sql += sql_null("Expt_inp", "i")+', ';
			sql += sql_null("ac_history_inp", "v")+', ';
			sql += sql_null("society_history_inp", "i")+', ';
			sql += sql_null("it_history_inp", "i")+', ';
			sql += sql_null("noit_history_inp", "i")+', ';
			sql += $("#del_flg_inp").prop('checked')+', ';
			sql += '"'+now+'", ';
			sql += '"'+'iwata'+'");';// ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆã‚ã¨ã§æ›¸ãæ›ãˆã‚‹ï¼‰
			console.log(sql);
			DB.sql(sql);
			window.location.reload();
		}
	});

	// æ›´æ–°ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®OKãƒœã‚¿ãƒ³ãŒæŠ¼ä¸‹ã•ã‚ŒãŸã¨ã
	$("#update_ok").on("click",function(){
		if(error("update")){
			// ç¤¾å“¡æƒ…å ±æ›´æ–°ç”¨ã®SQLæ–‡
			let sql = 'UPDATE TM_staff ';
			sql += 'SET staff_name="'+$("#staff_name_inp").val()+'", ';
			sql += 'birthday='+sql_null("birthday_inp", "d")+', ';
			sql += 'join_date='+sql_null("join_date_inp", "d")+', ';
			sql += 'pt='+sql_null("pt_inp", "i")+', ';
			sql += 'Expt='+sql_null("Expt_inp", "i")+', ';
			sql += 'ac_history='+sql_null("ac_history_inp", "v")+', ';
			sql += 'society_history='+sql_null("society_history_inp", "i")+', ';
			sql += 'it_history='+sql_null("it_history_inp", "i")+', ';
			sql += 'noit_history='+sql_null("noit_history_inp", "i")+', ';
			sql += 'del_flg='+$("#del_flg_inp").prop('checked')+', ';
			sql += 'update_date="'+now+'", ';
			sql += 'update_id="'+'iwata'+'" ';// ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆã‚ã¨ã§æ›¸ãæ›ãˆã‚‹ï¼‰
			sql += 'WHERE staff_id="'+$("#staff_id_inp").val()+'";';
			console.log(sql);
			DB.sql(sql);
			window.location.reload();
		}
	});

	// sqlç”¨nullãƒã‚§ãƒƒã‚¯
	function sql_null(inp, type){
		let inp_str = $("#"+inp).val();
		if(inp_str==null || inp_str=="" || inp_str=="null"){
			// inputã®å€¤ãŒnullã®å ´åˆ
			return 'null';
		}else{
			// inputã®å€¤ãŒnullã§ã¯ãªã„ã®å ´åˆ
			if(type=="i"){
				// ãƒ‡ãƒ¼ã‚¿å‹ãŒæ•°å€¤å‹ã®å ´åˆ
				return inp_str;
			}else{
				// ãƒ‡ãƒ¼ã‚¿å‹ãŒæ–‡å­—å‹,æ—¥ä»˜å‹ã®å ´åˆ
				return '"'+inp_str+'"';
			}
		}
	}

	// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
	function error(type){
		let error_check = true;

		document.getElementById("error_1").hidden = true;
		document.getElementById("error_2").hidden = true;
		document.getElementById("error_3").hidden = true;
		document.getElementById("error_4").hidden = true;
		document.getElementById("error_5").hidden = true;
		document.getElementById("error_6").hidden = true;
		document.getElementById("error_7").hidden = true;
		document.getElementById("error_8").hidden = true;
		document.getElementById("error_9").hidden = true;
		document.getElementById("error_10").hidden = true;

		// ç¤¾å“¡ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆ
		if($("#staff_id_inp").val() == ""){
			document.getElementById("error_1").hidden = false;
			error_check = false;
		}
		// æ°åãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆ
		if($("#staff_name_inp").val() == ""){
			document.getElementById("error_2").hidden = false;
			error_check = false;
		}
		// DBã«æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹ç¤¾å“¡ç•ªå·ã‚’ç™»éŒ²ã—ãŸå ´åˆ
		if(type!="update"){
			for(let i=0; i<staff.length; i++){
				if(staff[i]["staff_id"] == $("#staff_id_inp").val()){
					document.getElementById("error_3").hidden = false;
					error_check = false;
				}
			}
		}
		// ç¤¾å“¡ç•ªå·ãŒ6æ¡ã§ãªã„å ´åˆ
		if($("#staff_id_inp").val().length != 6){
			document.getElementById("error_4").hidden = false;
			error_check = false;
		}
		// æ°åãŒ20æ–‡å­—ä»¥å†…ã§ãªã„å ´åˆ
		if($("#staff_name_inp").val().length > 20){
			document.getElementById("error_5").hidden = false;
			error_check = false;
		}
		// ptã®å€¤ãŒ-32768ï½32767ã§ãªã„å ´åˆ
		if(-32768 > $("#pt_inp").val() || $("#pt_inp").val() > 32767){
			document.getElementById("error_6").hidden = false;
			error_check = false;
		}
		// Exptã®å€¤ãŒ-32768ï½32767ã§ãªã„å ´åˆ
		if(-32768 > $("#Expt_inp").val() || $("#Expt_inp").val() > 32767){
			document.getElementById("error_7").hidden = false;
			error_check = false;
		}
		// å‹¤ç¶šå¹´æ•°ã®å€¤ãŒ-128ï½127ã§ãªã„å ´åˆ
		if(-128 > $("#society_history_inp").val() || $("#society_history_inp").val() > 127){
			document.getElementById("error_8").hidden = false;
			error_check = false;
		}
		// ITçµŒé¨“(å¹´)ã®å€¤ãŒ-128ï½127ã§ãªã„å ´åˆ
		if(-128 > $("#it_history_inp").val() || $("#it_history_inp").val() > 127){
			document.getElementById("error_9").hidden = false;
			error_check = false;
		}
		// ITä»¥å¤–çµŒé¨“(å¹´)ã®å€¤ãŒ-128ï½127ã§ãªã„å ´åˆ
		if(-128 > $("#noit_history_inp").val() || $("#noit_history_inp").val() > 127){
			document.getElementById("error_10").hidden = false;
			error_check = false;
		}
		return error_check;
	}


	// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å‡¦ç†
	$("#UPDATE").hide();
	$("#INSERT").hide();
	$("#BACK").hide();
	$("#pop_back").hide();
	
	$("#back_button").on("click",function(){
		$("#BACK").show();
		$("#pop_back").show();
	})
	
	$("#insert_button").on("click",function(){
		$("#INSERT").show();
		$("#pop_back").show();
	})
	
	$("#update_button").on("click",function(){
		$("#UPDATE").show();
		$("#pop_back").show();
	})
	
	$(".pop_cancel").on("click",function(){
		$("#UPDATE").hide();
		$("#INSERT").hide();
		$("#BACK").hide();
		$("#pop_back").hide();
	})
	
	$("#update_ok").on("click",function(){
		$("#UPDATE").hide();
		$("#INSERT").hide();
		$("#BACK").hide();
		$("#pop_back").hide();
	})
	
	$("#insert_ok").on("click",function(){
		$("#UPDATE").hide();
		$("#INSERT").hide();
		$("#BACK").hide();
		$("#pop_back").hide();
	})
	
	$("#back_ok").on("click",function(){
		$("#UPDATE").hide();
		$("#INSERT").hide();
		$("#BACK").hide();
		$("#pop_back").hide();
		location.href='ev_select.html'
	})
	
</script>
</html>

