<html>
<head>
	<meta charset="UTF-8">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<link rel="stylesheet" href="style.css">
	<script src="DB_sql.js"></script>
</head>
<body>
	<h1>個人成績評価表</h1>
	<div class="f">
		<table border="1">
			<tr>
				<th>社員番号</th>
				<th>氏名</th>
				<th>生年月日</th>
				<th>年齢</th>
				<th>入社日</th>
				<th>勤続年数</th>
			</tr>
			<tr>
				<td id="staff_id"></td>
				<td id="staff_name"></td>
				<td id="staff_birthday"></td>
				<td id="staff_old"></td>
				<td id="staff_join_date"></td>
				<td id="staff_society_history"></td>
			</tr>
		</table>
		<table border="1">
			<tr>
				<th>学歴</th>
				<th>基本給</th>
			</tr>
			<tr>
				<td id="staff_ac_history"></td>
				<td id="staff_money"></td>
			</tr>
		</table>
		<table border="1">
			<tr>
				<th colspan="2">総合計</th>
			</tr>
			<tr>
				<th>pt</th>
				<th>Expt</th>
			</tr>
			<tr>
				<td id="staff_pt"></td>
				<td id="staff_Expt"></td>
			</tr>
		</table>
	</div>
	<table border="1" id="cp_table">
		<tr>
			<th>取得タイトル</th>
			<th>pt</th>
			<th>Expt</th>
		</tr>
	</table>
	<table border="1">
		<tr>
			<th colspan="2">社会人歴(中途)</th>
		</tr>
		<tr>
			<th>IT</th>
			<td id="staff_ithistory"></td>
		</tr>
		<tr>
			<th>IT以外</th>
			<td id="staff_noithistory"></td>
		</tr>
	</table>
	<table border="1">
		<tr>
			<th colspan="2">pt</th>
		</tr>
		<tr>
			<th>IT</th>
			<td id="staff_itpoint"></td>
		</tr>
	</table>
	<table border="1">
		<tr>
			<th>IT以外</th>
			<td id="staff_noitpoint"></td>
		</tr>
	</table>
	<table border="1">
		<tr>
			<th colspan="2">現在</th>
		</tr>
		<tr>
			<th>入社</th>
			<th id="n_day"></th>
		</tr>
		<tr>
			<th id="n_old"></th>
			<td id="noit_point"></td>
		</tr>
	</table>
	<table border="1">
		<tr>
			<th></th>
			<th colspan="3">前々年度</th>
			<th colspan="3">前年度</th>
			<th colspan="3">今年度</th>
		</tr>
		<tr>
			<th>一回目</th>
			<th>日付</th>
			<td id="two_year_pt">pt</td>
			<td id="two_year_Expt">Expt</td>
			<th>日付</th>
			<td id="last_year_pt">pt</td>
			<td id="last_year_Expt">Expt</td>
			<th>日付</th>
			<td id="year_pt">pt</td>
			<td id="year_Expt">Expt</td>
		</tr>
		<tr>
			<th>二回目</th>
			<th>日付</th>
			<td id="two_year_two_pt">pt</td>
			<td id="two_year_two_Expt">Expt</td>
			<th>日付</th>
			<td id="last_year_two_pt">pt</td>
			<td id="last_year_two_Expt">Expt</td>
			<th>日付</th>
			<td id="year_two_pt">pt</td>
			<td id="year_two_Expt">Expt</td>
		</tr>
		<tr>
			<th>過去三年以前の合計</th>
			<td id="old3_pt">pt</td>
			<td id="old3_Expt" colspan="2">Expt</td>
			<th colspan="3">総合計</th>
			<td id="allsum_pt">pt</td>
			<td id="allsum_Expt" colspan="2">Expt</td>
		</tr>
	</table>
	<button id="back">終了</button>
	<button id="selfcheck_button">自己評価</button>
	<button id="company_button">会社評価</button>
	<button id="csv_button">出力</button>
</body>
<script>
	let DB_generation_point="-"
	let generation="-";
	let staff_sum_pt=0;
	let staff_sum_Expt=0;
	let birthday = "-";
	let job_history="-";
	let staff_old="-";
	let staff_society_history="-";
	let DB_staff = DB.sql("select * from TM_staff");
	let staff_id_check = localStorage.getItem("ev_staff_id_assess");
	let DB_sumall = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and result=1;');
	let DB_staff_cp_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_cp join tm_point on te_staff_cp.title_cd=tm_point.title_cd where staff_id="'+staff_id_check+'";')
	if(DB_sumall[0]["pt"]!=null&&DB_staff_cp_point[0]["pt"]!=null&&DB_sumall[0]["Expt"]!=null&&DB_staff_cp_point[0]["Expt"]!=null){
		staff_sum_pt = parseInt(DB_sumall[0]["pt"]) + parseInt(DB_staff_cp_point[0]["pt"]);
		staff_sum_Expt = parseInt(DB_sumall[0]["Expt"]) + parseInt(DB_staff_cp_point[0]["Expt"]);
	}
	DB.sql('update tm_staff set pt='+staff_sum_pt+',Expt='+staff_sum_Expt+' where staff_id="'+staff_id_check+'"');
	DB_staff = DB.sql("select * from TM_staff");
	let salary_cp = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_cp join tm_point on te_staff_cp.title_cd=tm_point.title_cd where staff_id="'+staff_id_check+'";');
	let date = new Date();
	let date_yyyymm = date.toISOString();
	let ev_date = date_yyyymm.slice(0,7);
	let year = ev_date.slice(0,4);
	let month = ev_date.slice(5,7);
	if(parseInt(month)<=9&&parseInt(month)>3){
		month="09";
	}else{
		month="03";
	}
	let staff_check = "";
	for(i=0;i<DB_staff.length;i++){
		if(DB_staff[i]["staff_id"]==staff_id_check){
			staff_check = i;
		}
	}
	console.log('select salary from TM_salary where pt<='+DB_staff[staff_check]["pt"]+' and Expt<='+DB_staff[staff_check]["Expt"]+' order by salary desc;')
	let DB_salary = DB.sql('select salary from TM_salary where pt<='+DB_staff[staff_check]["pt"]+' and Expt<='+DB_staff[staff_check]["Expt"]+' order by salary desc;');
	if(DB_staff[staff_check]["birthday"]!=null){
		birthday = DB_staff[staff_check]["birthday"].slice(0,4);
	}
	if(DB_staff[staff_check]["join_date"]!=null){
		job_history = DB_staff[staff_check]["join_date"].slice(0,4);
	}
	if(DB_staff[staff_check]["birthday"]!=null){
		staff_old = parseInt(year)-parseInt(birthday);
	}
	if(DB_staff[staff_check]["join_date"]!=null){
		staff_society_history = parseInt(year)-parseInt(job_history);
	}
	
	//一番上のテーブルにデータを入れる
	$("#staff_id").text(DB_staff[staff_check]["staff_id"]);
	$("#staff_name").text(DB_staff[staff_check]["staff_name"]);
	$("#staff_birthday").text(DB_staff[staff_check]["birthday"]);
	$("#staff_old").text(staff_old);
	$("#staff_join_date").text(DB_staff[staff_check]["join_date"]);
	$("#staff_society_history").text(staff_society_history);
	$("#staff_ac_history").text(DB_staff[staff_check]["ac_history"]);
	$("#staff_money").text(DB_salary[0]["salary"]);
	$(staff_pt).text(DB_staff[staff_check]["pt"]);
	$(staff_Expt).text(DB_staff[staff_check]["Expt"]);
	
	//取得タイトル出力
	let DB_cp = DB.sql('SELECT TE_staff_cp.title_cd,detail,pt,Expt FROM TE_staff_cp join TM_point on TE_staff_cp.title_cd=TM_point.title_cd where staff_id = "'+DB_staff[staff_check]["staff_id"]+'";');
	for(i=0;i<DB_cp.length;i++){
		$("#cp_table").append('<tr><td>'+DB_cp[i]["detail"]+'</td><td>'+DB_cp[i]["pt"]+'</td><td>'+DB_cp[i]["Expt"]+'</td></tr>');
	}
	
	//社会人歴出力
	$(staff_ithistory).text(DB_staff[staff_check]["it_history"]);
	$(staff_noithistory).text(DB_staff[staff_check]["noit_history"]);
	$("#staff_itpoint").text(DB_staff[staff_check]["it_history"]*4);
	$("#staff_noitpoint").text(DB_staff[staff_check]["noit_history"]*2);
	$("#n_day").text(staff_society_history+"年目");
	if(job_history!="-"&&birthday=="-"){
		generation = parseInt(job_history)-parseInt(birthday);
		generation = (Math.floor(generation/10)) * 10;
	}
	$("#n_old").text(generation+"代");
	let sql_selectitem = "";
	if(staff_society_history==0){
		sql_selectitem = "1th"
	}else if(staff_society_history==1){
		sql_selectitem = "2th"
	}else if(staff_society_history==2){
		sql_selectitem = "3th"
	}else if(staff_society_history==3){
		sql_selectitem = "4th"
	}else if(staff_society_history>=4){
		sql_selectitem = "5th_over"
	}
	if(generation!="-"&&DB_staff[staff_check]["noit_history"]!=null){
		DB_generation_point=DB.sql('SELECT '+sql_selectitem+' FROM TM_noit_point where generation='+generation+' and not_it = '+DB_staff[staff_check]["noit_history"]*2);
	}
	$("#noit_point").text(DB_generation_point[0][sql_selectitem]);
	
	//自己評価シートの履歴
	let last_year = parseInt(year) - 1;
	let two_year = parseInt(year) - 2;
	let three_year = parseInt(year) - 3;
	if(parseInt(month)==9){
		let year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+year+'-09-01" and result=1;');
		let last_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+last_year+'-09-01" and result=1;');
		let two_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+two_year+'-09-01" and result=1;');
		let year_two_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+year+'-03-01" and result=1;');
		let last_year_two_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+last_year+'-03-01" and result=1;');
		let two_year_two_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+two_year+'-03-01" and result=1;');
		$("#year_pt").text(year_point[0]["pt"]);
		$("#year_Expt").text(year_point[0]["Expt"]);
		$("#last_year_pt").text(last_year_point[0]["pt"]);
		$("#last_year_Expt").text(last_year_point[0]["Expt"]);
		$("#two_year_pt").text(two_year_point[0]["pt"]);
		$("#two_year_Expt").text(two_year_point[0]["Expt"]);
		$("#year_two_pt").text("-");
		$("#year_two_Expt").text("-");
		$("#last_year_two_pt").text(year_two_point[0]["pt"]);
		$("#last_year_two_Expt").text(year_two_point[0]["Expt"]);
		$("#two_year_two_pt").text(last_year_two_point[0]["pt"]);
		$("#two_year_two_Expt").text(last_year_two_point[0]["Expt"]);
	}else{
		let year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+year+'-09-01" and result=1;');
		let last_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+last_year+'-09-01" and result=1;');
		let two_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+two_year+'-09-01" and result=1;');
		let year_two_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+year+'-03-01" and result=1;');
		let last_year_two_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+last_year+'-03-01" and result=1;');
		let two_year_two_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+two_year+'-03-01" and result=1;');
		let three_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date="'+three_year+'-09-01" and result=1;');
		$("#year_pt").text(last_year_point[0]["pt"]);
		$("#year_Expt").text(last_year_point[0]["Expt"]);
		$("#last_year_pt").text(two_year_point[0]["pt"]);
		$("#last_year_Expt").text(two_year_point[0]["Expt"]);
		$("#two_year_pt").text(three_year_point[0]["pt"]);
		$("#two_year_Expt").text(three_year_point[0]["Expt"]);
		$("#year_two_pt").text(year_two_point[0]["pt"]);
		$("#year_two_Expt").text(year_two_point[0]["Expt"]);
		$("#last_year_two_pt").text(last_year_two_point[0]["pt"]);
		$("#last_year_two_Expt").text(last_year_two_point[0]["Expt"]);
		$("#two_year_two_pt").text(two_year_two_point[0]["pt"]);
		$("#two_year_two_Expt").text(two_year_two_point[0]["Expt"]);
	}
	
	//過去三年間
	if(parseInt(month)==9){
		let DB_two_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date<"'+two_year+'-09-01" and result=1;');
		$("#old3_pt").text(DB_two_year_point[0]["pt"]);
		$("#old3_Expt").text(DB_two_year_point[0]["Expt"]);
	}else{
		let DB_three_year_point = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date<"'+three_year+'-09-01" and result=1;');
		$("#old3_pt").text(DB_three_year_point[0]["pt"]);
		$("#old3_Expt").text(DB_three_year_point[0]["Expt"]);
	}
	let DB_old3 = DB.sql('select sum(pt) as pt ,sum(Expt) as Expt from te_staff_sc join tm_self_check on te_staff_sc.sc_cd=tm_self_check.sc_cd where staff_id="'+staff_id_check+'" and  assess_date<"'+two_year+'-09-01" and result=1;');
	//総合計
	$("#allsum_pt").text(DB_sumall[0]["pt"]);
	$("#allsum_Expt").text(DB_sumall[0]["Expt"]);
	
	//戻るボタン押下時
	$("#back").on("click",function(){
		location.href='ev_assess_start.html'
	})
	
	$("#selfcheck_button").on("click",function(){
		location.href='ev_self_assess.html'
	})
	
	$("#company_button").on("click",function(){
		location.href='ev_company_assess.html'
	})

	$("#csv_button").on("click",function(){
		//配列の作成
		let csv_fail = new Array(33);
		csv_fail[10] = new Array(DB_cp.length);
		csv_fail[11] = new Array(DB_cp.length);
		csv_fail[12] = new Array(DB_cp.length);
		
		//配列にデータを挿入
		
		//一番上のテーブルのデータを挿入
		csv_fail[0] = DB_staff[staff_check]["staff_id"];
		csv_fail[1] = DB_staff[staff_check]["staff_name"]
		csv_fail[2] = DB_staff[staff_check]["birthday"]
		csv_fail[3] = staff_old
		csv_fail[4] = DB_staff[staff_check]["join_date"]
		csv_fail[5] = staff_society_history
		csv_fail[6] = DB_staff[staff_check]["ac_history"]
		csv_fail[7] = DB_salary[0]["salary"]
		csv_fail[8] = DB_staff[staff_check]["pt"]
		csv_fail[9] = DB_staff[staff_check]["Expt"]
		
		//取得した資格のデータを挿入
		for(i=0;i<DB_cp.length;i++){
			csv_fail[10][i] = DB_cp[i]["detail"];
			csv_fail[11][i] = DB_cp[i]["pt"];
			csv_fail[12][i] = DB_cp[i]["Expt"];
		}
		
		csv_fail[13] = DB_staff[staff_check]["it_history"];
		csv_fail[14] = DB_staff[staff_check]["noit_history"];
		csv_fail[15] = DB_generation_point[0][sql_selectitem];
		csv_fail[16] = $("#two_year_pt").text();
		csv_fail[17] = $("#two_year_Expt").text();
		csv_fail[18] = $("#two_year_two_pt").text();
		csv_fail[19] = $("#two_year_two_Expt").text();
		csv_fail[20] = $("#last_year_pt").text();
		csv_fail[21] = $("#last_year_Expt").text();
		csv_fail[22] = $("#last_year_two_pt").text();
		csv_fail[23] = $("#last_year_two_Expt").text();
		csv_fail[24] = $("#last_year_Expt").text();
		csv_fail[25] = $("#year_pt").text();
		csv_fail[26] = $("#year_Expt").text();
		csv_fail[27] = $("#year_two_pt").text();
		csv_fail[28] = $("#year_two_Expt").text();
		csv_fail[29] = $("#old3_pt").text();
		csv_fail[30] = $("#old3_Expt").text();
		csv_fail[31] = $("#allsum_pt").text();
		csv_fail[32] = $("#allsum_Expt").text();
		
		//配列を文字列に変換
		let csv_fail_change = csv_fail[0]+",";
		
		for (i=1;i<10;i++) {
			csv_fail_change += csv_fail[i]+",";
		}
		
		for (i=13;i<32;i++) {
			csv_fail_change += csv_fail[i]+",";
		}
		
		csv_fail_change += csv_fail[32];
		
		for(i=1;i<DB_cp.length;i++){
			csv_fail_change += ","+csv_fail[10][i]+','+csv_fail[11][i]+','+csv_fail[12][i];
		}
		// 文字列をBlobオブジェクトに変換
		let bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
		let blob = new Blob([bom, csv_fail_change], {type: 'text/csv'});
		let url = (window.URL || window.webkitURL).createObjectURL(blob);
		//クラスを作成
		let csv_click = document.createElement('a');
		//ダウンロードにファイル名を追加?
		csv_click.download = staff_id_check+DB_staff[staff_check]["staff_name"]+'_result.csv';
		//先ほど作ったurlを追加
		csv_click.href = url;
		// aタグをクリック
		csv_click.click();

	})

</script>
</html>

